{"version":3,"file":"dead-clicks-autocapture.js","sourceRoot":"","sources":["../../../src/extensions/dead-clicks-autocapture.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from '../posthog-core'\nimport { DEAD_CLICKS_ENABLED_SERVER_SIDE } from '../constants'\nimport { isBoolean, isObject } from '../utils/type-utils'\nimport { assignableWindow, document, LazyLoadedDeadClicksAutocaptureInterface } from '../utils/globals'\nimport { createLogger } from '../utils/logger'\nimport { DeadClicksAutoCaptureConfig, RemoteConfig } from '../types'\n\nconst logger = createLogger('[Dead Clicks]')\n\nexport const isDeadClicksEnabledForHeatmaps = () => {\n    return true\n}\nexport const isDeadClicksEnabledForAutocapture = (instance: DeadClicksAutocapture) => {\n    const isRemoteEnabled = !!instance.instance.persistence?.get_property(DEAD_CLICKS_ENABLED_SERVER_SIDE)\n    const clientConfig = instance.instance.config.capture_dead_clicks\n    return isBoolean(clientConfig) ? clientConfig : isRemoteEnabled\n}\n\nexport class DeadClicksAutocapture {\n    get lazyLoadedDeadClicksAutocapture(): LazyLoadedDeadClicksAutocaptureInterface | undefined {\n        return this._lazyLoadedDeadClicksAutocapture\n    }\n\n    private _lazyLoadedDeadClicksAutocapture: LazyLoadedDeadClicksAutocaptureInterface | undefined\n\n    constructor(\n        readonly instance: PostHog,\n        readonly isEnabled: (dca: DeadClicksAutocapture) => boolean,\n        readonly onCapture?: DeadClicksAutoCaptureConfig['__onCapture']\n    ) {\n        this.startIfEnabled()\n    }\n\n    public onRemoteConfig(response: RemoteConfig) {\n        if (this.instance.persistence) {\n            this.instance.persistence.register({\n                [DEAD_CLICKS_ENABLED_SERVER_SIDE]: response?.captureDeadClicks,\n            })\n        }\n        this.startIfEnabled()\n    }\n\n    public startIfEnabled() {\n        if (this.isEnabled(this)) {\n            this.loadScript(() => {\n                this.start()\n            })\n        }\n    }\n\n    private loadScript(cb: () => void): void {\n        if (assignableWindow.__PosthogExtensions__?.initDeadClicksAutocapture) {\n            // already loaded\n            cb()\n        }\n        assignableWindow.__PosthogExtensions__?.loadExternalDependency?.(\n            this.instance,\n            'dead-clicks-autocapture',\n            (err) => {\n                if (err) {\n                    logger.error('failed to load script', err)\n                    return\n                }\n                cb()\n            }\n        )\n    }\n\n    private start() {\n        if (!document) {\n            logger.error('`document` not found. Cannot start.')\n            return\n        }\n\n        if (\n            !this._lazyLoadedDeadClicksAutocapture &&\n            assignableWindow.__PosthogExtensions__?.initDeadClicksAutocapture\n        ) {\n            const config = isObject(this.instance.config.capture_dead_clicks)\n                ? this.instance.config.capture_dead_clicks\n                : {}\n            config.__onCapture = this.onCapture\n\n            this._lazyLoadedDeadClicksAutocapture = assignableWindow.__PosthogExtensions__.initDeadClicksAutocapture(\n                this.instance,\n                config\n            )\n            this._lazyLoadedDeadClicksAutocapture.start(document)\n            logger.info(`starting...`)\n        }\n    }\n\n    stop() {\n        if (this._lazyLoadedDeadClicksAutocapture) {\n            this._lazyLoadedDeadClicksAutocapture.stop()\n            this._lazyLoadedDeadClicksAutocapture = undefined\n            logger.info(`stopping...`)\n        }\n    }\n}\n"]}