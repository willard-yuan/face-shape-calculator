{"version":3,"file":"index.cjs","sources":["../../src/index.ts"],"sourcesContent":["import { ImageBase } from \"@vibrant/image\";\nimport type {\n\tImageSource,\n\tImageData as VibrantImageData,\n} from \"@vibrant/image\";\n\nfunction isRelativeUrl(url: string): boolean {\n\tconst u = new URL(url, location.href);\n\treturn (\n\t\tu.protocol === location.protocol &&\n\t\tu.host === location.host &&\n\t\tu.port === location.port\n\t);\n}\n\nfunction isSameOrigin(a: string, b: string): boolean {\n\tconst ua = new URL(a);\n\tconst ub = new URL(b);\n\n\t// https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\n\treturn (\n\t\tua.protocol === ub.protocol &&\n\t\tua.hostname === ub.hostname &&\n\t\tua.port === ub.port\n\t);\n}\n\nexport class BrowserImage extends ImageBase {\n\timage: HTMLImageElement | undefined;\n\tprivate _canvas: HTMLCanvasElement | undefined;\n\tprivate _context: CanvasRenderingContext2D | undefined;\n\tprivate _width: number | undefined;\n\tprivate _height: number | undefined;\n\n\tprivate _getCanvas() {\n\t\tif (!this._canvas) {\n\t\t\tthrow new Error(\"Canvas is not initialized\");\n\t\t}\n\n\t\treturn this._canvas;\n\t}\n\tprivate _getContext() {\n\t\tif (!this._context) {\n\t\t\tthrow new Error(\"Context is not initialized\");\n\t\t}\n\n\t\treturn this._context;\n\t}\n\tprivate _getWidth() {\n\t\tif (!this._width) {\n\t\t\tthrow new Error(\"Width is not initialized\");\n\t\t}\n\n\t\treturn this._width;\n\t}\n\tprivate _getHeight() {\n\t\tif (!this._height) {\n\t\t\tthrow new Error(\"Height is not initialized\");\n\t\t}\n\n\t\treturn this._height;\n\t}\n\n\tprivate _initCanvas(): void {\n\t\tconst img = this.image;\n\t\tif (!img) {\n\t\t\tthrow new Error(\"Image is not initialized\");\n\t\t}\n\t\tconst canvas = (this._canvas = document.createElement(\"canvas\"));\n\t\tconst context = canvas.getContext(\"2d\");\n\n\t\tif (!context) throw new ReferenceError(\"Failed to create canvas context\");\n\n\t\tthis._context = context;\n\n\t\tcanvas.className = \"@vibrant/canvas\";\n\t\tcanvas.style.display = \"none\";\n\n\t\tthis._width = canvas.width = img.width;\n\t\tthis._height = canvas.height = img.height;\n\n\t\tcontext.drawImage(img, 0, 0);\n\n\t\tdocument.body.appendChild(canvas);\n\t}\n\n\tload(image: ImageSource): Promise<this> {\n\t\tlet img: HTMLImageElement;\n\t\tlet src: string;\n\t\tif (typeof image === \"string\") {\n\t\t\timg = document.createElement(\"img\");\n\t\t\tsrc = image;\n\n\t\t\tif (!isRelativeUrl(src) && !isSameOrigin(window.location.href, src)) {\n\t\t\t\timg.crossOrigin = \"anonymous\";\n\t\t\t}\n\n\t\t\timg.src = src;\n\t\t} else if (image instanceof HTMLImageElement) {\n\t\t\timg = image;\n\t\t\tsrc = image.src;\n\t\t} else {\n\t\t\treturn Promise.reject(\n\t\t\t\tnew Error(`Cannot load buffer as an image in browser`),\n\t\t\t);\n\t\t}\n\t\tthis.image = img;\n\n\t\treturn new Promise<this>((resolve, reject) => {\n\t\t\tconst onImageLoad = () => {\n\t\t\t\tthis._initCanvas();\n\t\t\t\tresolve(this);\n\t\t\t};\n\n\t\t\tif (img.complete) {\n\t\t\t\t// Already loaded\n\t\t\t\tonImageLoad();\n\t\t\t} else {\n\t\t\t\timg.onload = onImageLoad;\n\t\t\t\timg.onerror = (_e) => reject(new Error(`Fail to load image: ${src}`));\n\t\t\t}\n\t\t});\n\t}\n\n\tclear(): void {\n\t\tthis._getContext().clearRect(0, 0, this._getWidth(), this._getHeight());\n\t}\n\n\tupdate(imageData: VibrantImageData): void {\n\t\tthis._getContext().putImageData(imageData as ImageData, 0, 0);\n\t}\n\n\tgetWidth(): number {\n\t\treturn this._getWidth();\n\t}\n\n\tgetHeight(): number {\n\t\treturn this._getHeight();\n\t}\n\n\tresize(targetWidth: number, targetHeight: number, ratio: number): void {\n\t\tif (!this.image) {\n\t\t\tthrow new Error(\"Image is not initialized\");\n\t\t}\n\t\tthis._width = this._getCanvas().width = targetWidth;\n\t\tthis._height = this._getCanvas().height = targetHeight;\n\n\t\tthis._getContext().scale(ratio, ratio);\n\t\tthis._getContext().drawImage(this.image, 0, 0);\n\t}\n\n\tgetPixelCount(): number {\n\t\treturn this._getWidth() * this._getHeight();\n\t}\n\n\tgetImageData(): ImageData {\n\t\treturn this._getContext().getImageData(\n\t\t\t0,\n\t\t\t0,\n\t\t\tthis._getWidth(),\n\t\t\tthis._getHeight(),\n\t\t);\n\t}\n\n\tremove(): void {\n\t\tif (this._canvas && this._canvas.parentNode) {\n\t\t\tthis._canvas.parentNode.removeChild(this._canvas);\n\t\t}\n\t}\n}\n"],"names":["ImageBase","image"],"mappings":"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"}